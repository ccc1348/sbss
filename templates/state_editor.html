<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ '新增' if is_new else '編輯' }}步驟 - {{ profile }}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/common.js"></script>
    <style>
        .container { max-width: 1200px; }
        .main { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .panel h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 15px; }
        .btn-save { width: 100%; padding: 12px; font-size: 16px; }
        .help-text { font-size: 12px; color: var(--text-muted); margin-top: 10px; line-height: 1.5; }
        .empty-regions { color: var(--text-muted); font-size: 13px; }
        .screenshot-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .screenshot-header h2 { flex: 1; font-size: 16px; }
    </style>
</head>
<body>
    <div class="container" x-data="editorPage()" x-init="init()">
        <!-- 設備選擇欄 -->
        <div class="device-bar" x-data="deviceBar()" x-init="init()">
            <span class="device-bar-label">控制設備：</span>
            <select x-model="selected" @change="save()" :disabled="loading">
                <template x-if="loading">
                    <option value="">掃描中...</option>
                </template>
                <template x-if="!loading && devices.length === 0">
                    <option value="">未偵測到設備</option>
                </template>
                <template x-for="d in devices" :key="d.id">
                    <option :value="d.id" x-text="d.name"></option>
                </template>
            </select>
            <button @click="refresh()">重新整理</button>
            <span class="status" :class="statusClass" x-text="status"></span>
        </div>

        <div class="header">
            <a href="/profile/{{ profile }}" class="back">&larr;</a>
            <h1 class="flex-1" style="font-size: 20px;">{{ '新增' if is_new else '編輯' }}步驟</h1>
        </div>

        <div class="main">
            <div class="panel">
                <div class="screenshot-header">
                    <h2>截圖</h2>
                    <button class="btn btn-secondary" @click="takeScreenshot()">擷取畫面</button>
                </div>

                <div class="mode-buttons">
                    <button class="mode-btn" :class="{ active: mode === 'click' }" @click="mode = 'click'">選擇點擊位置</button>
                    <button class="mode-btn" :class="{ active: mode === 'region' }" @click="mode = 'region'">選擇區域</button>
                </div>

                <div class="canvas-container">
                    <div class="placeholder" x-show="!imageData">點擊「擷取畫面」取得畫面</div>
                    <canvas id="canvas" x-show="imageData" style="display:none;"></canvas>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>步驟名稱</h3>
                    <div class="form-group">
                        <input type="text" x-model="stateName" placeholder="例：進入副本">
                    </div>
                </div>

                <div class="panel">
                    <h3>點擊位置</h3>
                    <div class="coord-display" :class="{ empty: !clickPos }">
                        <span x-text="clickPos ? `(${clickPos[0]}, ${clickPos[1]})` : '點擊截圖選擇'"></span>
                    </div>
                </div>

                <div class="panel">
                    <h3>比對區域</h3>
                    <ul class="region-list">
                        <template x-for="(r, i) in regions" :key="i">
                            <li class="region-item">
                                <div class="color" :style="{ background: regionColors[i % regionColors.length] }"></div>
                                <span x-text="`[${r.join(', ')}]`"></span>
                                <button @click="removeRegion(i)">&times;</button>
                            </li>
                        </template>
                    </ul>
                    <div class="empty-regions" x-show="regions.length === 0">拖拽截圖選擇區域</div>
                </div>

                <div class="panel mt-auto">
                    <button class="btn btn-success btn-save" @click="saveState()">儲存</button>
                    <div class="help-text">
                        1. 先截圖<br>
                        2. 點擊選擇「點擊位置」<br>
                        3. 切換到「選擇區域」拖拽選擇特徵區域<br>
                        4. 儲存
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function editorPage() {
            const profileName = "{{ profile }}";
            const isNew = {{ 'true' if is_new else 'false' }};
            const regionColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'];

            return {
                profileName,
                isNew,
                regionColors,
                stateName: "{{ state_name or '' }}",
                mode: 'click',
                clickPos: {{ config.click | tojson if config and config.get('click') else 'null' }},
                regions: [],
                imageData: null,
                imageWidth: 0,
                imageHeight: 0,
                scale: 1,
                canvas: null,
                ctx: null,
                isDragging: false,
                dragStart: null,
                dragEnd: null,

                init() {
                    // 初始化已有區域
                    {% if config %}
                        {% if config.get('region') %}
                            this.regions = [{{ config.region | tojson }}];
                        {% elif config.get('regions') %}
                            this.regions = {{ config.regions | tojson }};
                        {% endif %}
                    {% endif %}

                    // 如果是編輯模式，載入已有截圖
                    {% if not is_new %}
                    this.loadExistingScreenshot();
                    {% endif %}
                },

                async loadExistingScreenshot() {
                    const res = await fetch(`/api/profile/${encodeURIComponent(this.profileName)}/state/${encodeURIComponent("{{ state_name }}")}/screenshot`);
                    const data = await res.json();

                    if (data.error) {
                        console.log('No existing screenshot');
                        return;
                    }

                    this.imageData = data.image;
                    this.imageWidth = data.width;
                    this.imageHeight = data.height;
                    this.setupCanvas();
                },

                async takeScreenshot() {
                    const device = getSelectedDevice();
                    if (!device) {
                        alert('請先選擇設備');
                        return;
                    }

                    const res = await fetch(`/api/screenshot?device=${encodeURIComponent(device)}`);
                    const data = await res.json();

                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    this.imageData = data.image;
                    this.imageWidth = data.width;
                    this.imageHeight = data.height;
                    this.setupCanvas();
                },

                setupCanvas() {
                    this.canvas = document.getElementById('canvas');
                    this.canvas.style.display = 'block';
                    this.ctx = this.canvas.getContext('2d');

                    const maxWidth = 500;
                    this.scale = Math.min(maxWidth / this.imageWidth, 1);
                    this.canvas.width = this.imageWidth * this.scale;
                    this.canvas.height = this.imageHeight * this.scale;

                    const img = new Image();
                    img.onload = () => {
                        this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
                        this.drawOverlays();
                    };
                    img.src = 'data:image/png;base64,' + this.imageData;

                    this.canvas.onmousedown = (e) => this.onMouseDown(e);
                    this.canvas.onmousemove = (e) => this.onMouseMove(e);
                    this.canvas.onmouseup = (e) => this.onMouseUp(e);
                    this.canvas.onmouseleave = (e) => this.onMouseUp(e);
                },

                drawOverlays() {
                    if (!this.ctx || !this.imageData) return;

                    const img = new Image();
                    img.onload = () => {
                        this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);

                        // 畫區域
                        this.regions.forEach((r, i) => {
                            this.ctx.strokeStyle = this.regionColors[i % this.regionColors.length];
                            this.ctx.lineWidth = 2;
                            this.ctx.strokeRect(
                                r[0] * this.scale,
                                r[1] * this.scale,
                                (r[2] - r[0]) * this.scale,
                                (r[3] - r[1]) * this.scale
                            );
                        });

                        // 畫拖拽中的區域
                        if (this.isDragging && this.dragStart && this.dragEnd) {
                            this.ctx.strokeStyle = '#fff';
                            this.ctx.setLineDash([5, 5]);
                            this.ctx.lineWidth = 2;
                            const x = Math.min(this.dragStart.x, this.dragEnd.x);
                            const y = Math.min(this.dragStart.y, this.dragEnd.y);
                            const w = Math.abs(this.dragEnd.x - this.dragStart.x);
                            const h = Math.abs(this.dragEnd.y - this.dragStart.y);
                            this.ctx.strokeRect(x, y, w, h);
                            this.ctx.setLineDash([]);
                        }

                        // 畫點擊位置
                        if (this.clickPos) {
                            const x = this.clickPos[0] * this.scale;
                            const y = this.clickPos[1] * this.scale;

                            this.ctx.strokeStyle = '#2ecc71';
                            this.ctx.lineWidth = 2;

                            this.ctx.beginPath();
                            this.ctx.moveTo(x - 15, y);
                            this.ctx.lineTo(x + 15, y);
                            this.ctx.moveTo(x, y - 15);
                            this.ctx.lineTo(x, y + 15);
                            this.ctx.stroke();

                            this.ctx.fillStyle = '#2ecc71';
                            this.ctx.beginPath();
                            this.ctx.arc(x, y, 5, 0, Math.PI * 2);
                            this.ctx.fill();
                        }
                    };
                    img.src = 'data:image/png;base64,' + this.imageData;
                },

                onMouseDown(e) {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    if (this.mode === 'click') {
                        this.clickPos = [Math.round(x / this.scale), Math.round(y / this.scale)];
                        this.drawOverlays();
                    } else {
                        this.isDragging = true;
                        this.dragStart = { x, y };
                        this.dragEnd = { x, y };
                    }
                },

                onMouseMove(e) {
                    if (!this.isDragging) return;

                    const rect = this.canvas.getBoundingClientRect();
                    this.dragEnd = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                    this.drawOverlays();
                },

                onMouseUp(e) {
                    if (!this.isDragging) return;
                    this.isDragging = false;

                    if (this.dragStart && this.dragEnd) {
                        const x1 = Math.round(Math.min(this.dragStart.x, this.dragEnd.x) / this.scale);
                        const y1 = Math.round(Math.min(this.dragStart.y, this.dragEnd.y) / this.scale);
                        const x2 = Math.round(Math.max(this.dragStart.x, this.dragEnd.x) / this.scale);
                        const y2 = Math.round(Math.max(this.dragStart.y, this.dragEnd.y) / this.scale);

                        if (x2 - x1 > 10 && y2 - y1 > 10) {
                            this.regions.push([x1, y1, x2, y2]);
                        }
                    }

                    this.dragStart = null;
                    this.dragEnd = null;
                    this.drawOverlays();
                },

                removeRegion(index) {
                    this.regions.splice(index, 1);
                    this.drawOverlays();
                },

                async saveState() {
                    if (!this.stateName.trim()) {
                        alert('請輸入步驟名稱');
                        return;
                    }
                    if (!this.clickPos) {
                        alert('請選擇點擊位置');
                        return;
                    }
                    if (this.regions.length === 0) {
                        alert('請選擇至少一個區域');
                        return;
                    }
                    if (!this.imageData && this.isNew) {
                        alert('請先截圖');
                        return;
                    }

                    const payload = {
                        name: this.stateName.trim(),
                        click: this.clickPos,
                        regions: this.regions,
                        screenshot: this.imageData
                    };

                    if (!this.isNew) {
                        payload.old_name = "{{ state_name or '' }}";
                    }

                    const res = await fetch(`/api/profile/${encodeURIComponent(this.profileName)}/state`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (data.success) {
                        window.location.href = `/profile/${encodeURIComponent(this.profileName)}`;
                    } else {
                        alert(data.error || '儲存失敗');
                    }
                }
            };
        }
    </script>
</body>
</html>
