<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設定 - Android 自動工具</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/common.js"></script>
    <style>
        .container { max-width: 600px; }
    </style>
</head>
<body>
    <div class="container" x-data="settingsPage()">
        <div class="header">
            <a href="/" class="back">&larr;</a>
            <h1 class="flex-1" style="font-size: 20px;">設定</h1>
        </div>

        <div class="panel">
            <div class="form-group">
                <label>比對閾值</label>
                <input type="number" x-model="settings.match_threshold" step="0.05" min="0" max="1">
                <div class="hint">0-1，越高越嚴格，建議 0.8</div>
            </div>

            <div class="divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label>短間隔（秒）</label>
                    <input type="number" x-model="settings.loop_interval" step="0.1" min="0.1">
                    <div class="hint">正常比對頻率</div>
                </div>
                <div class="form-group">
                    <label>長間隔（秒）</label>
                    <input type="number" x-model="settings.long_interval" step="1" min="1">
                    <div class="hint">連續未匹配後的等待</div>
                </div>
            </div>

            <div class="form-group">
                <label>未匹配閾值</label>
                <input type="number" x-model="settings.miss_threshold" step="1" min="1">
                <div class="hint">連續幾次未匹配後切換到長間隔</div>
            </div>

            <div class="divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label>點擊後最短等待（秒）</label>
                    <input type="number" x-model="settings.click_delay_min" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label>點擊後最長等待（秒）</label>
                    <input type="number" x-model="settings.click_delay_max" step="0.1" min="0">
                </div>
            </div>
            <div class="hint" style="margin-top: -10px;">點擊後隨機等待範圍，避免行為太規律</div>

            <div class="flex items-center gap-4" style="margin-top: 25px;">
                <button class="btn btn-primary" @click="save()">儲存</button>
                <span class="text-muted text-sm">儲存後需重啟運行才會生效</span>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast" :class="{ show: toastVisible }" x-text="toastMessage"></div>
    </div>

    <script>
        function settingsPage() {
            return {
                settings: {
                    match_threshold: {{ settings.match_threshold }},
                    loop_interval: {{ settings.loop_interval }},
                    long_interval: {{ settings.long_interval }},
                    miss_threshold: {{ settings.miss_threshold }},
                    click_delay_min: {{ settings.click_delay[0] }},
                    click_delay_max: {{ settings.click_delay[1] }}
                },
                toastVisible: false,
                toastMessage: '',

                showToast(msg) {
                    this.toastMessage = msg;
                    this.toastVisible = true;
                    setTimeout(() => this.toastVisible = false, 2000);
                },

                async save() {
                    const payload = {
                        match_threshold: parseFloat(this.settings.match_threshold),
                        loop_interval: parseFloat(this.settings.loop_interval),
                        long_interval: parseFloat(this.settings.long_interval),
                        miss_threshold: parseInt(this.settings.miss_threshold),
                        click_delay: [
                            parseFloat(this.settings.click_delay_min),
                            parseFloat(this.settings.click_delay_max)
                        ],
                        start_delay: 2,
                        debug: false
                    };

                    const res = await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        this.showToast('已儲存');
                    } else {
                        alert('儲存失敗');
                    }
                }
            };
        }
    </script>
</body>
</html>
