<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ name }} - Android 自動工具</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/common.js"></script>
    <style>
        .container { max-width: 900px; }
        .rename-btn {
            background: #333;
            border: none;
            color: #888;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .rename-btn:hover { background: var(--accent); color: #fff; }
        h1 { display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>
    <div class="container" x-data="profilePage()">
        <!-- 設備選擇欄 -->
        <div class="device-bar" x-data="deviceBar()" x-init="init()" x-ref="deviceBar">
            <span class="device-bar-label">控制設備：</span>
            <select x-model="selected" @change="save()" :disabled="loading || $store.runner.status === 'running'">
                <template x-if="loading">
                    <option value="">掃描中...</option>
                </template>
                <template x-if="!loading && devices.length === 0">
                    <option value="">未偵測到設備</option>
                </template>
                <template x-for="d in devices" :key="d.id">
                    <option :value="d.id" x-text="d.name"></option>
                </template>
            </select>
            <button @click="refresh()">重新整理</button>
            <span class="status" :class="statusClass" x-text="status"></span>
        </div>

        <div class="header">
            <a href="/" class="back">&larr;</a>
            <h1 class="flex-1">
                <span>{{ name }}</span>
                <button class="rename-btn" @click="renameModal.open()">改名</button>
            </h1>
            <button class="btn btn-outline-danger" @click="deleteProfile()">刪除腳本</button>
        </div>

        <!-- 運行控制 -->
        <div class="panel mb-4">
            <div class="flex items-center gap-4 mb-3">
                <div class="status-dot" :class="runner.status"></div>
                <span x-text="runner.status === 'running' ? '運行中' : '已停止'"></span>
            </div>
            <div class="flex gap-3 mb-3">
                <button class="btn btn-success" @click="startRunner()" :disabled="runner.status === 'running'">啟動</button>
                <button class="btn btn-danger" @click="stopRunner()" :disabled="runner.status !== 'running'">停止</button>
            </div>
            <div class="log-area" x-ref="logArea">
                <template x-for="log in runner.logs" :key="log.time + log.msg">
                    <div class="log-line">
                        <span class="log-time" x-text="log.time"></span>
                        <span x-text="log.msg"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- 狀態列表 -->
        <div class="section-header">
            <h2>步驟（執行順序）</h2>
            <a href="/profile/{{ name }}/add" class="btn btn-primary">+ 新增步驟</a>
        </div>

        <ul class="list" id="stateList" @dragover.prevent @drop="handleDrop($event)">
            {% if states %}
                {% for state_name, config in states.items() %}
                <li class="list-item draggable"
                    draggable="true"
                    data-name="{{ state_name }}"
                    @dragstart="handleDragStart($event, '{{ state_name }}')"
                    @dragend="handleDragEnd($event)"
                    @dragover="handleDragOver($event)">
                    <span class="drag-handle">☰</span>
                    <button class="toggle-btn {{ 'disabled' if not config.get('enabled', true) }}"
                            @click="toggleState('{{ state_name }}')">
                        {{ '✓' if config.get('enabled', true) else '' }}
                    </button>
                    <div class="flex-1">
                        <div class="mb-2"><strong>{{ state_name }}</strong></div>
                        <div class="text-muted text-sm">點擊 {{ config.get('click', []) }}</div>
                    </div>
                    <div class="flex gap-2">
                        <a href="/profile/{{ name }}/edit/{{ state_name }}" class="btn btn-secondary btn-small">編輯</a>
                        <button class="btn btn-secondary btn-small"
                                @click="toggleState('{{ state_name }}')">
                            {{ '停用' if config.get('enabled', true) else '啟用' }}
                        </button>
                        <button class="btn btn-danger btn-small" @click="deleteState('{{ state_name }}')">刪除</button>
                    </div>
                </li>
                {% endfor %}
            {% else %}
                <li class="empty-state">尚無步驟，點擊「+ 新增」開始</li>
            {% endif %}
        </ul>

        <!-- 改名 Modal -->
        <div class="modal" :class="{ show: renameModal.show }" @click="renameModal.backdropClick($event)">
            <div class="modal-content">
                <h2>重新命名腳本</h2>
                <input type="text" x-model="renameModal.newName" placeholder="新名稱"
                       @keyup.enter="renameProfile()">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" @click="renameModal.close()">取消</button>
                    <button class="btn btn-primary" @click="renameProfile()">確定</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Alpine Store for runner status
        document.addEventListener('alpine:init', () => {
            Alpine.store('runner', { status: 'stopped' });
        });

        function profilePage() {
            const profileName = "{{ name }}";

            return {
                profileName,
                runner: {
                    status: 'stopped',
                    logs: []
                },
                dragItem: null,
                renameModal: {
                    show: false,
                    newName: profileName,
                    open() { this.show = true; this.newName = profileName; },
                    close() { this.show = false; },
                    backdropClick(e) { if (e.target === e.currentTarget) this.close(); }
                },

                init() {
                    this.initSSE();
                },

                initSSE() {
                    const eventSource = new EventSource('/api/runner/stream');
                    eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.runner.status = data.status;
                        Alpine.store('runner').status = data.status;
                        if (data.logs.length > 0) {
                            this.runner.logs.push(...data.logs);
                            this.$nextTick(() => {
                                const area = this.$refs.logArea;
                                if (area) area.scrollTop = area.scrollHeight;
                            });
                        }
                    };
                    eventSource.onerror = () => {
                        console.log('SSE connection lost, reconnecting...');
                    };
                },

                async startRunner() {
                    const device = getSelectedDevice();
                    if (!device) {
                        alert('請先選擇設備');
                        return;
                    }

                    const res = await fetch(`/api/runner/start/${encodeURIComponent(profileName)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device })
                    });
                    const data = await res.json();
                    if (!data.success) alert(data.message);
                },

                async stopRunner() {
                    await fetch('/api/runner/stop', { method: 'POST' });
                },

                async toggleState(stateName) {
                    const res = await fetch(`/api/profile/${encodeURIComponent(profileName)}/state/${encodeURIComponent(stateName)}/toggle`, {
                        method: 'POST'
                    });
                    if (res.ok) location.reload();
                },

                async deleteState(stateName) {
                    if (!confirm(`確定刪除「${stateName}」？`)) return;

                    const res = await fetch(`/api/profile/${encodeURIComponent(profileName)}/state/${encodeURIComponent(stateName)}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) location.reload();
                },

                async deleteProfile() {
                    if (!confirm(`確定刪除腳本「${profileName}」？\n所有步驟和截圖都會被刪除。`)) return;

                    const res = await fetch(`/api/profile/${encodeURIComponent(profileName)}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) window.location.href = '/';
                },

                async renameProfile() {
                    const newName = this.renameModal.newName.trim();
                    if (!newName) return;

                    const res = await fetch(`/api/profile/${encodeURIComponent(profileName)}/rename`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });

                    if (res.ok) {
                        window.location.href = '/profile/' + encodeURIComponent(newName);
                    } else {
                        const data = await res.json();
                        alert(data.error || '改名失敗');
                    }
                },

                // 拖拽排序
                handleDragStart(e, name) {
                    this.dragItem = e.target;
                    e.target.classList.add('dragging');
                },

                handleDragEnd(e) {
                    e.target.classList.remove('dragging');
                    this.dragItem = null;
                    this.saveOrder();
                },

                handleDragOver(e) {
                    const item = e.target.closest('.list-item');
                    if (item && item !== this.dragItem) {
                        const rect = item.getBoundingClientRect();
                        const mid = rect.top + rect.height / 2;
                        if (e.clientY < mid) {
                            item.parentNode.insertBefore(this.dragItem, item);
                        } else {
                            item.parentNode.insertBefore(this.dragItem, item.nextSibling);
                        }
                    }
                },

                handleDrop(e) {
                    // Drop handled by dragend
                },

                async saveOrder() {
                    const items = document.querySelectorAll('#stateList .list-item[data-name]');
                    const order = Array.from(items).map(item => item.dataset.name);

                    await fetch(`/api/profile/${encodeURIComponent(profileName)}/reorder`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order })
                    });
                }
            };
        }
    </script>
</body>
</html>
