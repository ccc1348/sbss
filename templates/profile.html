<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ name }} - Android 自動工具</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/common.js"></script>
    <style>
        .container { max-width: 900px; }
        .rename-btn {
            background: #333;
            border: none;
            color: #888;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .rename-btn:hover { background: var(--accent); color: #fff; }
        h1 { display: flex; align-items: center; gap: 10px; }
        /* 順序模式 */
        .mode-toggle { display: flex; align-items: center; gap: 8px; }
        .mode-toggle label { font-size: 14px; color: var(--text-secondary); cursor: pointer; }
        .switch { position: relative; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .switch .slider {
            position: absolute; cursor: pointer; inset: 0;
            background: #444; border-radius: 24px; transition: 0.2s;
        }
        .switch .slider:before {
            content: ""; position: absolute; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.2s;
        }
        .switch input:checked + .slider { background: var(--accent); }
        .switch input:checked + .slider:before { transform: translateX(20px); }
        /* 當前步驟高亮 */
        .list-item.current-step { border-left: 3px solid var(--success); background: rgba(46, 204, 113, 0.1); }
        .list-item.pending-step { opacity: 0.5; }
        .step-index { font-size: 12px; color: var(--text-muted); margin-right: 8px; min-width: 24px; }
        .step-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        .step-badge.skippable { background: #f39c12; color: #000; }
        .step-badge.repeatable { background: #9b59b6; color: #fff; }
        .step-badge.current { background: var(--success); color: #fff; }
        .skippable-btn, .repeatable-btn { font-size: 11px; padding: 2px 8px; }
        .skippable-btn.active { background: #f39c12; color: #000; }
        .repeatable-btn.active { background: #9b59b6; color: #fff; }
    </style>
</head>
<body>
    <div class="container" x-data="profilePage()">
        <!-- 設備選擇欄 -->
        <div class="device-bar" x-data="deviceBar()" x-init="init()" x-ref="deviceBar">
            <span class="device-bar-label">控制設備：</span>
            <select x-model="selected" @change="save()" :disabled="loading || $store.runner.status === 'running'">
                <template x-if="loading">
                    <option value="">掃描中...</option>
                </template>
                <template x-if="!loading && devices.length === 0">
                    <option value="">未偵測到設備</option>
                </template>
                <template x-for="d in devices" :key="d.id">
                    <option :value="d.id" x-text="d.name"></option>
                </template>
            </select>
            <button @click="refresh()">重新整理</button>
            <span class="status" :class="statusClass" x-text="status"></span>
        </div>

        <div class="header">
            <a href="/" class="back">&larr;</a>
            <h1 class="flex-1">
                <span>{{ name }}</span>
                <button class="rename-btn" @click="renameModal.open()">改名</button>
            </h1>
            <button class="btn btn-outline-danger" @click="deleteProfile()">刪除腳本</button>
        </div>

        <!-- 警告橫幅 -->
        <div x-show="isOtherScriptRunning()" class="panel mb-4" style="background: rgba(231, 76, 60, 0.1); border: 1px solid var(--danger);">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">⚠️</span>
                <div>
                    <strong style="color: var(--danger);">無法操作此腳本</strong>
                    <div class="text-muted text-sm" style="margin-top: 4px;">
                        腳本「<span x-text="runner.profileName"></span>」正在運行中，請先停止該腳本
                    </div>
                </div>
            </div>
        </div>

        <!-- 運行控制 -->
        <div class="panel mb-4">
            <div class="flex items-center gap-4 mb-3">
                <div class="status-dot" :class="runner.status"></div>
                <span x-text="runner.status === 'running' ? '運行中' : '已停止'"></span>
                <template x-if="runner.status === 'running' && runner.sequentialMode">
                    <span class="text-muted text-sm" x-text="runner.currentStepName ? `目前: ${runner.currentStepName}` : '等待開始...'"></span>
                </template>
            </div>
            <div class="flex items-center gap-4 mb-3">
                <button class="btn btn-success" @click="startRunner()" :disabled="runner.status === 'running' || isOtherScriptRunning()">啟動</button>
                <button class="btn btn-danger" @click="stopRunner()" :disabled="runner.status !== 'running' || isOtherScriptRunning()">停止</button>
                <div class="mode-toggle" style="margin-left: auto;">
                    <label class="switch">
                        <input type="checkbox" :checked="sequentialMode" @change="toggleSequentialMode()" :disabled="runner.status === 'running' || isOtherScriptRunning()">
                        <span class="slider"></span>
                    </label>
                    <label @click="if(runner.status !== 'running' && !isOtherScriptRunning()) toggleSequentialMode()">順序模式</label>
                </div>
            </div>
            <div class="log-area" x-ref="logArea">
                <template x-for="log in runner.logs" :key="log.time + log.msg">
                    <div class="log-line">
                        <span class="log-time" x-text="log.time"></span>
                        <span x-text="log.msg"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- 狀態列表 -->
        <div class="section-header">
            <h2>步驟（執行順序）</h2>
            <button class="btn btn-primary" @click="window.location.href='/profile/{{ name }}/add'" :disabled="isOtherScriptRunning()">+ 新增步驟</button>
        </div>

        <ul class="list" id="stateList" @dragover.prevent @drop="handleDrop($event)">
            <template x-if="states.length === 0">
                <li class="empty-state">尚無步驟，點擊「+ 新增」開始</li>
            </template>
            <template x-for="(state, index) in states" :key="state.name">
                <li class="list-item draggable"
                    :draggable="!isOtherScriptRunning()"
                    :class="getStepClass(state.name, index)"
                    :style="isOtherScriptRunning() ? 'cursor: not-allowed; opacity: 0.6;' : ''"
                    @dragstart="!isOtherScriptRunning() && handleDragStart($event, index)"
                    @dragend="!isOtherScriptRunning() && handleDragEnd($event)"
                    @dragover="!isOtherScriptRunning() && handleDragOver($event, index)">
                    <span class="step-index" x-show="sequentialMode" x-text="index + 1"></span>
                    <span class="drag-handle">☰</span>
                    <button class="toggle-btn"
                            :class="{ disabled: !state.config.enabled }"
                            :title="state.config.enabled ? '停用功能' : '啟用功能'"
                            :disabled="isOtherScriptRunning()"
                            @click="toggleState(state.name)">
                        <span x-text="state.config.enabled ? '✓' : ''"></span>
                    </button>
                    <div class="flex-1">
                        <div class="mb-2">
                            <strong x-text="state.name"></strong>
                            <span class="step-badge current" x-show="runner.status === 'running' && runner.sequentialMode && runner.currentStepName === state.name">已執行</span>
                            <span class="step-badge skippable" x-show="sequentialMode && state.config.skippable">可略過</span>
                            <span class="step-badge repeatable" x-show="sequentialMode && state.config.repeatable">可重複</span>
                        </div>
                        <div class="text-muted text-sm">點擊 <span x-text="JSON.stringify(state.config.click || [])"></span></div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary btn-small skippable-btn"
                                :class="{ active: state.config.skippable }"
                                x-show="sequentialMode"
                                :disabled="isOtherScriptRunning()"
                                @click="toggleSkippable(state.name)"
                                :title="state.config.skippable ? '點擊設為必要步驟' : '點擊設為可略過'">
                            <span x-text="state.config.skippable ? '可略過' : '必要'"></span>
                        </button>
                        <button class="btn btn-secondary btn-small repeatable-btn"
                                :class="{ active: state.config.repeatable }"
                                x-show="sequentialMode"
                                :disabled="isOtherScriptRunning()"
                                @click="toggleRepeatable(state.name)"
                                :title="state.config.repeatable ? '點擊設為單次執行' : '點擊設為可重複'">
                            <span x-text="state.config.repeatable ? '可重複' : '單次'"></span>
                        </button>
                        <template x-if="!isOtherScriptRunning()">
                            <a :href="`/profile/{{ name }}/edit/${encodeURIComponent(state.name)}`" class="btn btn-secondary btn-small">編輯</a>
                        </template>
                        <template x-if="isOtherScriptRunning()">
                            <button class="btn btn-secondary btn-small" disabled>編輯</button>
                        </template>
                        <button class="btn btn-danger btn-small" :disabled="isOtherScriptRunning()" @click="deleteState(state.name)">刪除</button>
                    </div>
                </li>
            </template>
        </ul>

        <!-- 改名 Modal -->
        <div class="modal" :class="{ show: renameModal.show }" @click="renameModal.backdropClick($event)">
            <div class="modal-content">
                <h2>重新命名腳本</h2>
                <input type="text" x-model="renameModal.newName" placeholder="新名稱"
                       @keyup.enter="renameProfile()">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" @click="renameModal.close()">取消</button>
                    <button class="btn btn-primary" @click="renameProfile()">確定</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Alpine Store for runner status
        document.addEventListener('alpine:init', () => {
            Alpine.store('runner', { status: 'stopped' });
        });

        function profilePage() {
            const profileName = "{{ name }}";
            const statesData = {{ states_json|safe }};

            return {
                profileName,
                sequentialMode: {{ 'true' if sequential_mode else 'false' }},
                states: statesData,
                runner: {
                    status: 'stopped',
                    profileName: null,
                    logs: [],
                    lastLogId: 0,
                    sequentialMode: false,
                    currentStepIndex: -1,
                    currentStepName: null,
                    stepNames: []
                },
                dragIndex: null,
                eventSource: null,
                renameModal: {
                    show: false,
                    newName: profileName,
                    open() { this.show = true; this.newName = profileName; },
                    close() { this.show = false; },
                    backdropClick(e) { if (e.target === e.currentTarget) this.close(); }
                },

                getStateConfig(stateName, key, defaultValue) {
                    const state = this.states.find(s => s.name === stateName);
                    return state ? (state.config[key] ?? defaultValue) : defaultValue;
                },

                init() {
                    this.initSSE();
                },

                initSSE() {
                    // Close existing connection if any
                    if (this.eventSource) {
                        this.eventSource.close();
                    }

                    const url = `/api/runner/stream?since=${this.runner.lastLogId}`;
                    this.eventSource = new EventSource(url);

                    this.eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.runner.status = data.status;
                        this.runner.profileName = data.profile_name;
                        this.runner.sequentialMode = data.sequential_mode;
                        this.runner.currentStepIndex = data.current_step_index;
                        this.runner.currentStepName = data.current_step_name;
                        this.runner.stepNames = data.step_names || [];
                        Alpine.store('runner').status = data.status;
                        // 偵測日誌被清空（重新啟動）
                        if (data.last_log_id < this.runner.lastLogId) {
                            this.runner.logs = [];
                            this.runner.lastLogId = 0;
                        }
                        if (data.logs.length > 0) {
                            this.runner.logs.push(...data.logs);
                            this.runner.lastLogId = data.last_log_id;
                            this.$nextTick(() => {
                                const area = this.$refs.logArea;
                                if (area) area.scrollTop = area.scrollHeight;
                            });
                        }
                    };

                    this.eventSource.onerror = () => {
                        if (this.eventSource) {
                            this.eventSource.close();
                            this.eventSource = null;
                        }
                        setTimeout(() => this.initSSE(), 2000);  // 2 秒後自動重連
                    };
                },

                isOtherScriptRunning() {
                    return this.runner.status === 'running' && this.runner.profileName !== this.profileName;
                },

                async toggleSequentialMode() {
                    if (this.runner.status === 'running') return;
                    this.sequentialMode = !this.sequentialMode;
                    await fetch(`/api/profile/${encodeURIComponent(profileName)}/sequential`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled: this.sequentialMode })
                    });
                },

                async toggleSkippable(stateName) {
                    const state = this.states.find(s => s.name === stateName);
                    if (!state) return;

                    const newValue = !state.config.skippable;
                    state.config.skippable = newValue;

                    await fetch(`/api/profile/${encodeURIComponent(profileName)}/state/${encodeURIComponent(stateName)}/skippable`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ skippable: newValue })
                    });
                },

                async toggleRepeatable(stateName) {
                    const state = this.states.find(s => s.name === stateName);
                    if (!state) return;

                    const newValue = !state.config.repeatable;
                    state.config.repeatable = newValue;

                    await fetch(`/api/profile/${encodeURIComponent(profileName)}/state/${encodeURIComponent(stateName)}/repeatable`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ repeatable: newValue })
                    });
                },

                getStepClass(stateName, index) {
                    if (this.runner.status !== 'running' || !this.runner.sequentialMode) return '';
                    if (this.runner.currentStepName === stateName) return 'current-step';
                    // 已完成的步驟變淡（使用 stepNames 中的位置比較）
                    const stepIdx = this.runner.stepNames.indexOf(stateName);
                    const currentIdx = this.runner.currentStepIndex;
                    if (stepIdx >= 0 && currentIdx >= 0 && stepIdx < currentIdx) return 'pending-step';
                    return '';
                },

                async startRunner() {
                    const device = getSelectedDevice();
                    if (!device) {
                        alert('請先選擇設備');
                        return;
                    }

                    const res = await fetch(`/api/runner/start/${encodeURIComponent(profileName)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device })
                    });
                    const data = await res.json();
                    if (!data.success) alert(data.message);
                },

                async stopRunner() {
                    await fetch('/api/runner/stop', { method: 'POST' });
                },

                async toggleState(stateName) {
                    const res = await fetch(`/api/profile/${encodeURIComponent(profileName)}/state/${encodeURIComponent(stateName)}/toggle`, {
                        method: 'POST'
                    });
                    if (res.ok) location.reload();
                },

                async deleteState(stateName) {
                    if (!confirm(`確定刪除「${stateName}」？`)) return;

                    const res = await fetch(`/api/profile/${encodeURIComponent(profileName)}/state/${encodeURIComponent(stateName)}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) location.reload();
                },

                async deleteProfile() {
                    if (!confirm(`確定刪除腳本「${profileName}」？\n所有步驟和截圖都會被刪除。`)) return;

                    const res = await fetch(`/api/profile/${encodeURIComponent(profileName)}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) window.location.href = '/';
                },

                async renameProfile() {
                    const newName = this.renameModal.newName.trim();
                    if (!newName) return;

                    const res = await fetch(`/api/profile/${encodeURIComponent(profileName)}/rename`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });

                    if (res.ok) {
                        window.location.href = '/profile/' + encodeURIComponent(newName);
                    } else {
                        const data = await res.json();
                        alert(data.error || '改名失敗');
                    }
                },

                // 拖拽排序
                handleDragStart(e, index) {
                    this.dragIndex = index;
                    e.target.classList.add('dragging');
                },

                handleDragEnd(e) {
                    e.target.classList.remove('dragging');
                    this.dragIndex = null;
                    this.saveOrder();
                },

                handleDragOver(e, targetIndex) {
                    if (this.dragIndex === null || this.dragIndex === targetIndex) return;

                    // 從陣列中移除被拖曳的項目
                    const draggedItem = this.states[this.dragIndex];
                    this.states.splice(this.dragIndex, 1);

                    // 插入到新位置
                    // 如果往後拖，targetIndex 需要調整（因為已經移除了一個元素）
                    const insertIndex = this.dragIndex < targetIndex ? targetIndex - 1 : targetIndex;
                    this.states.splice(insertIndex, 0, draggedItem);

                    // 更新 dragIndex
                    this.dragIndex = insertIndex;
                },

                handleDrop(e) {
                    // Drop handled by dragend
                },

                async saveOrder() {
                    const order = this.states.map(s => s.name);

                    await fetch(`/api/profile/${encodeURIComponent(profileName)}/reorder`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order })
                    });
                }
            };
        }
    </script>
</body>
</html>
