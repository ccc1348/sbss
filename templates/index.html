<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android 自動工具</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/common.js"></script>
</head>
<body>
    <div class="container" x-data="indexPage()">
        <!-- 設備選擇欄 -->
        <div class="device-bar" x-data="deviceBar()" x-init="init()">
            <span class="device-bar-label">控制設備：</span>
            <select x-model="selected" @change="save()" :disabled="loading">
                <template x-if="loading">
                    <option value="">掃描中...</option>
                </template>
                <template x-if="!loading && devices.length === 0">
                    <option value="">未偵測到設備</option>
                </template>
                <template x-for="d in devices" :key="d.id">
                    <option :value="d.id" x-text="d.name"></option>
                </template>
            </select>
            <button @click="refresh()">重新整理</button>
            <span class="status" :class="statusClass" x-text="status"></span>
        </div>

        <div class="header header-between">
            <div>
                <h1>Android 自動工具</h1>
                <p class="subtitle">透過 ADB 自動辨識畫面並點擊，適用於 BlueStacks 等模擬器</p>
            </div>
            <a href="/settings" class="btn btn-secondary">設定</a>
        </div>

        <div class="section-title">我的腳本</div>
        <div class="grid grid-2 mb-4">
            {% for profile in profiles %}
            <a href="/profile/{{ profile }}" class="card">
                <div class="card-actions">
                    <button class="btn-icon" @click.prevent="renameModal.open({ name: '{{ profile }}' })">改名</button>
                    <button class="btn-icon" @click.prevent="cloneModal.open({ source: '{{ profile }}' })">複製</button>
                </div>
                <h3>{{ profile }}</h3>
            </a>
            {% endfor %}

            <div class="card card-add" @click="addModal.open()">+</div>
        </div>

        <div class="help-section">
            <h2>使用說明</h2>
            <div class="help-steps">
                <div class="help-step">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        <h4>建立腳本</h4>
                        <p>點擊 + 新增一個腳本，例如「刷副本」、「自動日常」</p>
                    </div>
                </div>
                <div class="help-step">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <h4>新增步驟</h4>
                        <p>每個步驟定義「看到什麼畫面 → 點擊哪裡」。截圖後選擇要辨識的區域和點擊位置</p>
                    </div>
                </div>
                <div class="help-step">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        <h4>調整順序</h4>
                        <p>拖拽步驟調整執行優先順序。程式會依序比對，匹配到就點擊</p>
                    </div>
                </div>
                <div class="help-step">
                    <div class="step-num">4</div>
                    <div class="step-content">
                        <h4>啟動運行</h4>
                        <p>點擊「啟動」開始自動化。可隨時暫停或停止</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增腳本 Modal -->
        <div class="modal" :class="{ show: addModal.show }" @click="addModal.backdropClick($event)" x-data="modal('add')" x-ref="addModal" x-init="$watch('addModal.show', v => show = v)">
            <div class="modal-content">
                <h2>新增腳本</h2>
                <input type="text" x-ref="input" x-model="addModal.name" placeholder="腳本名稱"
                       @keyup.enter="createScript()">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" @click="addModal.close()">取消</button>
                    <button class="btn btn-primary" @click="createScript()">建立</button>
                </div>
            </div>
        </div>

        <!-- 複製腳本 Modal -->
        <div class="modal" :class="{ show: cloneModal.show }" @click="cloneModal.backdropClick($event)">
            <div class="modal-content">
                <h2>複製腳本</h2>
                <p class="text-muted mb-3">從 <strong x-text="cloneModal.data.source"></strong> 複製</p>
                <input type="text" x-ref="cloneInput" x-model="cloneModal.newName" placeholder="新腳本名稱"
                       @keyup.enter="cloneScript()">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" @click="cloneModal.close()">取消</button>
                    <button class="btn btn-primary" @click="cloneScript()">複製</button>
                </div>
            </div>
        </div>

        <!-- 改名 Modal -->
        <div class="modal" :class="{ show: renameModal.show }" @click="renameModal.backdropClick($event)">
            <div class="modal-content">
                <h2>重新命名</h2>
                <input type="text" x-ref="renameInput" x-model="renameModal.newName" placeholder="新名稱"
                       @keyup.enter="renameScript()">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" @click="renameModal.close()">取消</button>
                    <button class="btn btn-primary" @click="renameScript()">確定</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function indexPage() {
            return {
                addModal: {
                    show: false,
                    name: '',
                    open() { this.show = true; this.name = ''; },
                    close() { this.show = false; },
                    backdropClick(e) { if (e.target === e.currentTarget) this.close(); }
                },
                cloneModal: {
                    show: false,
                    data: {},
                    newName: '',
                    open(data) {
                        this.data = data;
                        this.newName = data.source + '-副本';
                        this.show = true;
                    },
                    close() { this.show = false; this.data = {}; },
                    backdropClick(e) { if (e.target === e.currentTarget) this.close(); }
                },
                renameModal: {
                    show: false,
                    data: {},
                    newName: '',
                    open(data) {
                        this.data = data;
                        this.newName = data.name;
                        this.show = true;
                    },
                    close() { this.show = false; this.data = {}; },
                    backdropClick(e) { if (e.target === e.currentTarget) this.close(); }
                },

                async createScript() {
                    const name = this.addModal.name.trim();
                    if (!name) return;

                    const res = await fetch('/api/profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });

                    if (res.ok) {
                        window.location.href = '/profile/' + encodeURIComponent(name);
                    } else {
                        const data = await res.json();
                        alert(data.error || '建立失敗');
                    }
                },

                async cloneScript() {
                    const newName = this.cloneModal.newName.trim();
                    if (!newName) return;

                    const res = await fetch('/api/profile/' + encodeURIComponent(this.cloneModal.data.source) + '/clone', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });

                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const data = await res.json();
                        alert(data.error || '複製失敗');
                    }
                },

                async renameScript() {
                    const newName = this.renameModal.newName.trim();
                    if (!newName) return;

                    const res = await fetch('/api/profile/' + encodeURIComponent(this.renameModal.data.name) + '/rename', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });

                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const data = await res.json();
                        alert(data.error || '改名失敗');
                    }
                }
            };
        }
    </script>
</body>
</html>
