name: Build Windows

on:
  push:
    tags:
      - 'v*'  # 只有 v 開頭的 tag 才觸發 (如 v1.0.0)
  workflow_dispatch:  # 手動觸發

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Python Embedded
        run: |
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip" -OutFile "python-embed.zip"
          Expand-Archive -Path "python-embed.zip" -DestinationPath "python"
        shell: pwsh

      - name: Setup Embedded Python (enable pip & venv)
        run: |
          # 修改 pth 檔案以啟用 import site
          $pth = "python/python311._pth"
          (Get-Content $pth) -replace '#import site', 'import site' | Set-Content $pth

          # 下載並安裝 pip
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          ./python/python.exe get-pip.py --no-warn-script-location
        shell: pwsh

      - name: Create venv and install dependencies
        run: |
          ./python/python.exe -m venv venv
          ./venv/Scripts/pip.exe install -r requirements.txt --no-warn-script-location
        shell: pwsh

      - name: Download ADB platform-tools
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/android/repository/platform-tools-latest-windows.zip" -OutFile "platform-tools.zip"
          Expand-Archive -Path "platform-tools.zip" -DestinationPath "."
        shell: pwsh

      - name: Create run.bat
        run: |
          @'
          @echo off
          cd /d "%~dp0"
          start "" venv\Scripts\pythonw.exe web.py
          '@ | Set-Content -Path "run.bat" -Encoding ASCII
        shell: pwsh

      - name: Prepare release folder
        run: |
          mkdir release
          cp -r python release/
          cp -r venv release/
          cp -r platform-tools release/
          cp -r templates release/
          cp -r static release/
          cp *.py release/
          cp requirements.txt release/
          cp run.bat release/
        shell: bash

      - name: Zip release
        run: Compress-Archive -Path release/* -DestinationPath sbss-windows.zip
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: sbss-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
