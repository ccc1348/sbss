name: Build Windows (Electron)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download Python Embedded
        run: |
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip" -OutFile "python-embed.zip"
          Expand-Archive -Path "python-embed.zip" -DestinationPath "python"
        shell: pwsh

      - name: Setup Embedded Python (enable pip & site-packages)
        run: |
          # 修改 pth 檔案以啟用 import site 並加入上層目錄
          $pth = "python/python311._pth"
          $content = Get-Content $pth
          $content = $content -replace '#import site', 'import site'
          Set-Content $pth $content
          Add-Content $pth ".."
          Add-Content $pth "Lib\site-packages"

          # 下載並安裝 pip
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          ./python/python.exe get-pip.py --no-warn-script-location
        shell: pwsh

      - name: Install Python dependencies
        run: |
          ./python/python.exe -m pip install -r requirements.txt --no-warn-script-location

          # 驗證安裝
          ./python/python.exe -c "import flask; print('Flask OK')"
          ./python/python.exe -c "import cv2; print('OpenCV OK')"
          ./python/python.exe -c "import numpy; print('NumPy OK')"
        shell: pwsh

      - name: Download ADB platform-tools
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/android/repository/platform-tools-latest-windows.zip" -OutFile "platform-tools.zip"
          Expand-Archive -Path "platform-tools.zip" -DestinationPath "."
        shell: pwsh

      - name: Install npm dependencies
        run: npm install

      - name: Build Electron app
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare release package
        run: |
          # 建立發行資料夾
          New-Item -ItemType Directory -Force -Path "release"

          # 複製 Electron 打包結果
          Copy-Item -Path "dist/win-unpacked/*" -Destination "release" -Recurse

          # 複製 Python 環境到 resources/python
          Copy-Item -Path "python" -Destination "release/resources/" -Recurse -Force

          # 複製 platform-tools 到 resources/platform-tools
          Copy-Item -Path "platform-tools" -Destination "release/resources/" -Recurse -Force

          # 確認關鍵檔案存在
          Write-Host "=== Verifying release ==="
          $checks = @(
            "release/sbss.exe",
            "release/resources/app/web.py",
            "release/resources/app/core.py",
            "release/resources/app/main.js",
            "release/resources/app/templates/index.html",
            "release/resources/app/static/css/style.css",
            "release/resources/python/python.exe",
            "release/resources/platform-tools/adb.exe"
          )
          $allOk = $true
          foreach ($path in $checks) {
            if (Test-Path $path) {
              Write-Host "[OK] $path"
            } else {
              Write-Host "[MISSING] $path"
              $allOk = $false
            }
          }
          if (-not $allOk) {
            Write-Host "=== Full structure ==="
            Get-ChildItem -Path "release" -Recurse -Depth 3 | Select-Object FullName
            exit 1
          }

          # 測試 Python 能否正常執行
          Write-Host "=== Testing Python ==="
          & "release/resources/python/python.exe" -c "import flask; import cv2; import numpy; print('All imports OK')"
        shell: pwsh

      - name: Create debug launcher
        run: |
          # 建立 debug.bat 方便除錯
          @'
          @echo off
          echo Starting sbss in debug mode...
          cd /d "%~dp0"
          sbss.exe
          echo.
          echo === Press any key to close ===
          pause > nul
          '@ | Set-Content -Path "release/debug.bat" -Encoding ASCII
        shell: pwsh

      - name: Zip release
        run: Compress-Archive -Path "release/*" -DestinationPath "sbss-windows.zip"
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: sbss-windows.zip
          body: |
            ## 使用說明

            1. 解壓縮 `sbss-windows.zip` 到任意位置（建議避免中文路徑）
            2. 執行 `sbss.exe`
            3. 首次執行可能出現 Windows SmartScreen 警告，點擊「更多資訊」→「仍要執行」

            ## 錯誤排除

            **無法啟動？**
            - 執行 `debug.bat` 查看詳細錯誤訊息
            - 檢查日誌: `%APPDATA%\sbss\startup.log`

            **找不到設備？**
            - 確認模擬器已啟動並開啟 ADB 功能
            - BlueStacks: 設定 → 進階 → Android Debug Bridge
            - 雷電/夜神: 設定 → 其他設定 → ADB 調試

            **截圖失敗？**
            - 重啟模擬器後再試
            - 確認模擬器 ADB 端口正常（通常是 5555, 5556 等）
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
